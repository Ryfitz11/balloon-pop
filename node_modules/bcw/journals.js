#!/usr/bin/env node
const { printAlert, clearScreen, colors, printInfo, printSuccess } = require("./console-utils");
const { setupGit, initializeProject, writeLog, getOrSetGitUser } = require("./utils");
let { execSync } = require("child_process");


const CURR_DIR = process.cwd();
const projectName = "fs-journal";

async function create() {
  try{
    let gitUser = await getOrSetGitUser()
    if(!gitUser) {
      gitUser = await setupGit()
    }
    const { fullname, ghname, ghemail } = gitUser
    clearScreen();
    console.group(colors.FgMagenta, "---INITIALIZING PROJECT---");
    printInfo(`--------------------\n[+] CREATING PROJECT\n[+] ${projectName}`);

    let projPath = `${CURR_DIR}/${projectName}`;
    execSync(`npx create-project ${projectName} codeworks-templates/fs-journal#main --ghname="${ghname}" --ghemail="${ghemail}" --fullname="${fullname}"`);
    process.chdir(projPath);
    printInfo(`[~] INSTALLING DEPENDENCIES`);
    console.log('This will take a minute')
    execSync(`npm install --no-progress`);
    printInfo(`[+] DEPENDENCIES INSTALLED`);

    writeLog(`${CURR_DIR}\\${projectName}`, projectName)

    initializeProject(projectName);
    console.groupEnd()

    printSuccess("[+] Journal created successfully to get started");
    printSuccess(`[~] cd ${projectName} & npm run dev`);
    console.groupEnd();
  }catch(e){
    printAlert(`[!] ${e.message}`, e);
  }
}

async function start() {
  try {
    await create()
  } catch (e) {
    console.error(e)
  }
}

start()
